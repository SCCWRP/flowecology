---
title: ""
self_contained: yes
runtime: shiny
---

<br>

# Baseline conditions {.tabset}

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(shiny)
library(leaflet)
library(randomForest)

prj <- 4326 # geographic wgs84

source('R/funcs.R')

data(rchdat)
data(biodat)
data(bsflowmetest)
data(mod_chub_rf)
data(mod_sucker_rf)
data(mod_toad_rf)
data(mod_trout_rf)
data(mod_turtle_rf)
data(mod_vireo_rf)

# color palette function for prob map
pal <- colorNumeric(
  palette = RColorBrewer::brewer.pal(11, 'Spectral'),
  na.color = 'yellow',
  domain = c(0, 1)
)
```

```{r mastinp}
column(width = 12,

       column(width = 4, 
              
              # select species to show
              selectInput("spmap", "Choose species:", sort(unique(biodat$name)))
                
        ), 
       
       column(width = 4,
              
              # select metric type
              selectInput("mettyp", "Select predictor type:", choices = c('Flow'))
       
        ),
       
       column(width = 4, 
              
              renderUI({
                
                # input
                mettyp <- input$mettyp
                
                if(mettyp == 'Flow'){
                  selectInput('bstyp', 'Select baseline conditions:', choices = list(dry = '2014-07-01', moderate = '2010-07-01', wet = '1993-07-01'))
              
                }
                
              })
              
        )
       
)
```

```{r reactives}
# rf model to use from species selection
spmod <- reactive({
  
  # input
  spmap <- input$spmap
  
  req(spmap)
  
  modnm <- gsub('^.*\\s(.*)$', '\\1', spmap) %>% 
    paste0('mod_', ., '_rf')
  
  out <- eval(parse(text = modnm))
  
  return(out)
  
})

# baseline metrics to use
bsmets <- reactive({
  
  # input
  bstyp <- input$bstyp
  
  req(bstyp)
  
  # filter baseline metrics by year selection
  out <- bsflowmetest %>% 
    filter(dtsl %in% as.Date(bstyp)) %>% 
    dplyr::select(var, COMID, est) %>% 
    spread(var, est)
  
  return(out)
  
})

# probability of occurrence predictions for species and baseline condition
bsprds <- reactive({
  
  # input
  spmod <- spmod()
  bsmets <- bsmets()
  
  # get predictions by comid
  out <- bsmets %>% 
    mutate(
      procc = predict(spmod, newdata = bsmets, type = 'prob')[, 1, drop = T]
    ) %>% 
    dplyr::select(COMID, procc)
  
  return(out)
  
})

# map of predictions by comid 
bsprdsmap <- reactive({
  
  # input
  bsprds <- bsprds()
  
  tomap <- rchdat %>% 
    left_join(bsprds, by = 'COMID')

  out <- mapview(tomap, layer.name = 'reset') %>% 
    .@map
  
  return(out)

})
```

```{r}
output$bsprdsmap <- renderLeaflet({bsprdsmap()})
```
```{r}
leafletOutput('bsprdsmap')

observe({
    
    input$spmap
    
    # reactives
    bsprds <- bsprds()
  
    tomap <- rchdat %>% 
      left_join(bsprds, by = 'COMID')

    # spp prob map
    mapout <- leafletProxy("bsprdsmap", data = tomap) %>%
      clearMarkers() %>%
      clearShapes() %>%
      clearControls() %>%
      addPolylines(opacity = 1, weight = 1, color = ~pal(procc)) %>% 
      # label = ~paste0(COMID, ', Likely score:', as.character(round(lns, 2)))
      # ) %>%
      addLegend("topright", pal = pal(), values = ~procc,
                title = "Pr. occurence", opacity = 1
      )

})
  
```



