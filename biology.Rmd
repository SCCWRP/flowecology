---
title: ""
self_contained: yes
runtime: shiny
---

<br>

## Biological data

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(plotly)
library(shiny)
library(leaflet)
library(kableExtra)
library(mapedit)

prj <- "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"

source('R/funcs.R')

data(biodat)
data(rchdat)
```

```{r mastinp}
column(width = 12,

       column(width = 6, 
              
              # year slider
              sliderInput("yearssh", label = 'Select year ranges to show:',  
                min = 1983, max = 2018, 
                value = c(1983, 2018),
                sep = '', ticks = FALSE
              )
            
       ), 
       
       column(width = 6, 
              
              # select species to show
              selectInput("spmap", "Choose species:", sort(unique(biodat$name)))
                
        )
       
)
```

This map shows the stream network and locations with biological data.  Select a species and year range for surveys to view locations.

```{r reactives}

# species data to plot
# mapsel can't go in here, nested too deeply
sprct <- reactive({
  
  # input
  spmap <- input$spmap
  yearssh <- input$yearssh
  
  out <- biodat %>% 
    filter(name %in% spmap) %>% 
    filter(yr >= yearssh[1] & yr <= yearssh[2])

  return(out)
  
})

# selection from map as sf object, same crs as biodat
mapsel <- reactive({

  # return NULL is no map selection
  if(is.null(edits()()$finished)){
    
    out <- NULL
  
  # otherwise return selection after crs transform  
  } else {
    
    # transform
    out <- edits()()$finished %>% 
      st_transform(st_crs(biodat))
    
  }
  
  return(out)
  
})

# species data for table, from sprct
sprcttab <- reactive({

  # input
  sprct <- sprct()
  mapsel <- mapsel()
  
  # subset sprct if map selection made 
  if(!is.null(mapsel)){
    
    sprcttmp <- st_intersection(mapsel, sprct)
    if(nrow(sprcttmp) != 0){
      
      sprct <- sprcttmp
      
    } 

  }
  
  # get coordinates, remove from obj
  crds <- st_coordinates(sprct) %>% 
    data.frame
  st_geometry(sprct) <- NULL

  # format for table
  sprcttab <- sprct %>%
    mutate(
      date = as.character(date), 
      latitude = crds$Y,
      longitude = crds$X
      ) %>% 
    dplyr::select(FID_1, latitude, longitude, date, occurrence, source) %>% 
    unique
    
  return(sprcttab)
  
})

# map of species data
spmap <- reactive({
  
  # input
  sprct <- sprct()

  # get colors, pt size
  occol <- sprct$occol
  occex <- sprct$occex
  
  # remove irrelevant columns
  tomap <- sprct %>% 
    select(-occol, -occex, -FID_1)

  out <- mapview(rchdat, homebutton = F, color = 'grey') + 
    mapview(tomap, zcol = 'occurrence', col.region = occol, cex = occex, legend = T, homebutton = F, layer = 'occurrence')
 
  return(out)
 
})

# get number of sites sampled by year for a species
yrsmp <- reactive({
  
  # input
  sprct <- sprct()
  mapsel <- mapsel()
  
  # full year range
  yrs <- range(sprct$yr, na.rm = T)
  yrs <- seq(yrs[1], yrs[2])
  yrs <- data.frame(yr = yrs)

  # subset sprct if map selection made 
  if(!is.null(mapsel)){
    
    sprcttmp <- st_intersection(mapsel, sprct)
    if(nrow(sprcttmp) != 0){
      
      sprct <- sprcttmp
      
    } 

  }
  
  st_geometry(sprct) <- NULL

  # summarize  
  out <- sprct %>%
    select(name, yr, FID_1) %>% 
    na.omit %>% 
    unique %>% 
    group_by(yr) %>% 
    mutate(count = n()) %>% 
    ungroup %>% 
    select(yr, count) %>% 
    unique %>% 
    left_join(yrs, ., by = 'yr') %>% 
    tidyr::complete(yr)
  
  return(out)
  
})

# get number of sites where species was present/absent complete cases
yrcnt <- reactive({
  
  # input
  sprct <- sprct()
  mapsel <- mapsel()
  
  # full year range, by occurrence
  yrs <- range(sprct$yr, na.rm = T)
  yrs <- seq(yrs[1], yrs[2])
  yrs <- crossing(
    yr = yrs, 
    occurrence = c('present', 'absent')
  )

  # subset sprct if map selection made 
  if(!is.null(mapsel)){
    
    sprcttmp <- st_intersection(mapsel, sprct)
    if(nrow(sprcttmp) != 0){
      
      sprct <- sprcttmp
      
    } 

  }
  st_geometry(sprct) <- NULL
  
  # summarize
  out <- sprct %>%
    select(name, yr, occurrence) %>% 
    na.omit %>% 
    group_by(yr, occurrence) %>% 
    summarise(count = n()) %>% 
    ungroup %>% 
    left_join(yrs, ., by = c('yr', 'occurrence')) %>% 
    tidyr::complete(yr, occurrence)
  
  return(out)
  
})
```

```{r spmap}
# mapview/leaflet with selection
editModUI('editor', height = 500)
edits <- reactive({callModule(editMod, 'editor', spmap()@map)})
renderUI(edits()())
```

<br></br>

Number of sites sampled by year for `r renderText(input$spmap)`, `r renderText(input$yearssh[1])` to `r renderText(input$yearssh[2])`:

```{r ploinp}
# select plot type to show
selectInput("ploinp", "Select plot type to show:", 
  choices = c(
    'Presence/absence site counts' = 'pa',
    'Total site counts' = 'tot'
    )
)
```

```{r plosit}
# count plot, as reactive for download
plosit <- reactive({

  # inputs
  ploinp <- input$ploinp
  yrcnt <- yrcnt()
  yrsmp <- yrsmp()

  # pa plot
  if(ploinp == 'pa'){
    
    out <- ggplot(yrcnt, aes(x = yr, group = occurrence, fill = occurrence, y = count)) + 
      geom_line() +
      geom_point(pch = 21, size = 5) +
      theme_bw(base_size = 16) +
      theme(
        axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = c(0.95, 0.9), 
        legend.title = element_blank(), 
        legend.background = element_blank()
      ) + 
      scale_fill_manual(values = c('tomato1', 'lightgreen')) +
      scale_y_continuous('Number of locations') + 
      scale_x_continuous(breaks = unique(yrcnt$yr))
  
  # tot plot
  } else {
    
    out <- ggplot(yrsmp, aes(x = yr, y = count)) + 
      geom_line(colour = 'black') +
      geom_point(pch = 21, size = 5, fill = 'grey') +
      theme_bw(base_size = 16) +
      theme(
        axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = 'top', 
        legend.title = element_blank()
      ) + 
      scale_y_continuous('Number of locations') + 
      scale_x_continuous(breaks = unique(yrsmp$yr))
    
  }  
  
  return(out)

})
```

```{r plositdl}
# button to download the plot 
downloadHandler(
  filename = function() { 'bioplo.pdf' },
  content = function(file) {
  
    # add informative title to plot
    out <- plosit() + 
      ggtitle(paste0(input$spmap, ', ', input$yearssh[1], ' to ', input$yearssh[2]))
    
    # save
    pdf(file, width = 11, height = 6, family = 'serif')
    print(out)
    dev.off()
    
 }
)
```

```{r, out.width = "100%"}
downloadButton('plodl', 'Download plot')
renderPlot({plosit()})
```

<br></br>
Tabular summary for `r renderText(input$spmap)`, `r renderText(input$yearssh[1])` to `r renderText(input$yearssh[2])`:

```{r}
downloadButton('tabdl', 'Download table')
```

```{r}
# table download
downloadHandler(
  filename = function() {'biotab.csv'},
  content = function(file) {
  
    write.csv(sprcttab(), file, quote = T, row.names = F)
    
  }
)
```

<br></br>
```{r, results = 'asis'}
renderDataTable({sprcttab()}, options = list(pageLength = 10))
```

