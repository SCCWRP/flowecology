---
title: ""
self_contained: yes
runtime: shiny
---

<br>

# Observed biology {.tabset}

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(shiny)
library(leaflet)

prj <- "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs"

source('R/funcs.R')

data(biodat)
data(rchdat)
data(bioflowmetest)
```

```{r mastinp}
column(width = 12,

       column(width = 4, 
              
              # select species to show
              selectInput("spmap", "Choose species:", sort(unique(biodat$name)))
                
        ), 
       
       column(width = 4,
              
              # select metric type
              selectInput("mettyp", "Select predictor type:", choices = c('Flow'))
       
        ),
       
       column(width = 4, 
              
              renderUI({
                
                # input
                mettyp <- input$mettyp
                
                if(mettyp == 'Flow'){
                  tosel <- names(bioflowmetest)
                  tosel <- tosel[!tosel %in% c('name', 'COMID', 'date', '<NA>')]
                }
                
                selectInput("metsel", "Select meric:", choices = tosel)
                
              })
              
        )
       
)
```

```{r reactives}
# species selection
sprct <- reactive({
  
  # input
  spmap <- input$spmap
  
  out <- biodat %>% 
    filter(name %in% spmap) 
  
  return(out)
  
})

# map of species data
spmap <- reactive({
  
  # input
  sprct <- sprct()
  
  # get pt size
  occex <- sprct$occex
  
  # colors
  cols <- c('tomato1', 'lightgreen')
  names(cols) <- c('absent', 'present')
  
  out <- mapview(rchdat, homebutton = F, color = 'black', legend = F, lwd = 0.5, alpha = 0.5, layer = 'Reaches') + 
    mapview(sprct, zcol = 'occurrence', legend = T, col.regions = cols, cex = occex, homebutton = F, layer = 'Occurrence')

  return(out)
 
})

# flowmet joined with biodat, biodat COMIDs filtered by rchdat COMID
spfldat <- reactive({
  
  # inputs
  metsel <- input$metsel
  spmap <- input$spmap
  sprct <- sprct()
  
  req(metsel)
  
  # filter flow metrics
  fldat <- bioflowmetest %>% 
    dplyr::select(name, COMID, date, !!metsel) %>% 
    filter(name %in% spmap)
  
  # join species and flow metric data
  out <- sprct %>% 
    filter(COMID %in% rchdat$COMID) %>% 
    left_join(fldat, by = c('name', 'date', 'COMID')) %>% 
    st_set_geometry(NULL) %>% 
    unique
  
  return(out)
  
})

# flowmet and biodata plot
spflplt <- reactive({
  
  # input
  spfldat <- spfldat()
  metsel <- input$metsel
  
  # plot data
  toplo <- spfldat %>% 
    filter(!is.na(occurrence)) %>% 
    mutate(
      occurrbin = case_when(
        occurrence %in% 'absent' ~ 0, 
        occurrence %in% 'present' ~ 1
      )
    ) %>% 
    rename(val = !!metsel)
 
  p <- ggplot(toplo, aes(x = val, y = occurrbin)) +
    geom_point(aes(fill = occurrence), size = 4, alpha = 0.7, pch = 21) +
    scale_fill_manual('Occcurence', values = c('tomato1', 'lightgreen')) +
    geom_smooth(method = "glm", method.args = list(family = "binomial"), fullrange = T) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    ylab('Pr. occurrence') + 
    xlab(metsel)
  
  return(p)
  
})
```

## Observed data

```{r spmap}
# mapview
output$spmap <- renderLeaflet({spmap()@map})
```
```{r}
leafletOutput('spmap')
```

## Modelled response

```{r}
output$spflplt <- renderPlot({spflplt()}, width = 500, height = 500)
```
```{r}
plotOutput('spflplt')
```

