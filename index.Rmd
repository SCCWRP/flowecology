---
self_contained: yes
output: 
  html_document:
    includes:
      in_header: cssloaders_in_header.html
runtime: shiny
---

## Biological responses of stream communities to climate change in the LA river basin {.tabset .tabset-pills}

```{r setup, include = FALSE}
# globals
library(knitr)
opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(sf)
library(mapview)
library(shiny)
library(leaflet)
library(stargazer)
library(randomForest)
library(shinycssloaders)

source('R/funcs.R')

data(biodat)
data(rchdat)
data(allrchdat)
data(obsbiomet)
data(futest)
data(bsest)

# color palette function for prob map
pal <- colorNumeric(
  palette = RColorBrewer::brewer.pal(11, 'RdYlBu'),
  na.color = NA,
  domain = c(0, 1)
)

# species choices
spls <- list('arroyo chub' = 'chub', 'arroyo toad' = 'toad', "least bell's vireo" = 'vireo', 'rainbow trout' = 'trout', 'santa ana sucker' = 'sucker', 'southwestern pond turtle' = 'turtle')
```

### Overview

This website is an interactive tool to demonstrate riparian and stream community responses to changes in hydrology in the Los Angeles and Ventura County watersheds, California, USA.  Biological response was modelled as a function of baseline and projected changes in temperature and flow using historical data and expected flow changes from down-scaled climate change models. This website is provided to enhance understanding of climate change effects on riparian dependent species to facilitate management of watershed, riparian, and in-stream habitats. 

#### Objectives and approach 

The objective of this website is to present the project results in a way that is meaningful to the interests of the advisory committee and others that can benefit from this project.  The website is designed to address the following questions:

* What historical biological or baseline flow data are relevant for regulatory or management communities to understand current conditions? 

* What changes in biological communities and flow are relevant for regulatory or management decisions in the region?

* What sources of uncertainty are of most concern to inform decision-making processes?

The website is structured following an analysis workflow that describes the biology, modelled hydrology, and biological response to flow changes. Data can viewed using different selection widgets and downloaded in tabular or graphical format. __The tabs at the top of the website link to separate components of the analysis.__

1) __Observed biology__: View and download biology data for the Los Angeles and Ventura County watersheds, historical data from existing surveys

1) __Baseline conditions__: View results for baseline conditions and modelled species results for stream reaches in the study region

1) __Future scenarios__: View results for future scenarios and modelled species results for stream reaches in the study region

#### Attribution

All site content and analyses by [Marcus Beck](mailto:marcusb@sccwrp.org), with assistance from [Jenny Taylor](mailto:jennyt@sccwrp.org), [Abel Santana](mailto:abels@sccwrp.org), and [Eric Stein](mailto:erics@sccwrp.org). View the web page source content [here](https://github.com/SCCWRP/flowecology).


### Observed biology {.tabset}

```{r}
column(width = 12,

  column(width = 4, 
        
        # select species to show
        selectInput("spmapobs", "Choose species:", choices = spls)
          
  ), 
  
  column(width = 4,
        
        # select metric type
        selectInput("mettypobs", "Select predictor type:", choices = c('Flow', 'Temperature'))
  
  ),
  
  column(width = 4, 
        
        renderUI({
          
          # input
          mettypobs <- input$mettypobs
          spmapobs <- input$spmapobs

          # pull metrics to select based on input
          tosel <- obsbiomet %>%
            filter(mettypobs %in% !!mettypobs) %>% 
            filter(spp %in% spmapobs) %>% 
            pull(met) %>% 
            unique
        
          selectInput("metsel", "Select meric:", choices = tosel)
          
        })
        
  )
       
)
```

```{r}
# species selection
sprct <- reactive({
  
  # input
  spmapobs <- input$spmapobs
  
  out <- biodat %>% 
    filter(spp %in% spmapobs) 
  
  return(out)
  
})

# map of species data
spmapobs <- reactive({
  
  # input
  sprct <- sprct()
  
  # get pt size
  occex <- sprct$occex
  
  # colors
  cols <- c('tomato1', 'lightgreen')
  names(cols) <- c('absent', 'present')
  
  out <- mapview(rchdat, homebutton = F, color = 'black', legend = F, lwd = 0.5, alpha = 0.5, layer = 'Reaches') + 
    mapview(sprct, zcol = 'occurrence', legend = T, col.regions = cols, cex = occex, homebutton = F, layer = 'Occurrence')

  return(out)
 
})

# metric data joined with biodat, biodat COMIDs filtered by rchdat COMID
spmtdat <- reactive({
  
  # input
  metsel <- input$metsel
  mettypobs <- input$mettypobs
  spmapobs <- input$spmapobs
  
  req(metsel)
    
  # minor format for output
  out <- obsbiomet %>% 
    filter(mettypobs %in% !!mettypobs) %>%
    filter(spp %in% spmapobs) %>% 
    filter(met %in% metsel) %>% 
    mutate(
      occurrence = factor(occurrence, levels = c('0', '1'), labels = c('absent', 'present')),
      occurrbin = case_when(
        occurrence %in% 'absent' ~ 0, 
        occurrence %in% 'present' ~ 1
      )
    ) 
  
  return(out)
  
})

# metric and biodata plot
spmtplt <- reactive({
  
  # input
  spmtdat <- spmtdat()
  metsel <- input$metsel
  
  req(metsel)

  p <- ggplot(spmtdat, aes(x = val, y = as.numeric(occurrbin))) +
    geom_point(aes(fill = occurrence), size = 4, alpha = 0.7, pch = 21) +
    scale_fill_manual('Occcurence', values = c('tomato1', 'lightgreen'), drop = FALSE) +
    geom_smooth(method = "glm", method.args = list(family = "binomial"), fullrange = T) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    ylab('Pr. occurrence') + 
    xlab(metsel)
  
  return(p)
  
})

# regression mod for spmtplt
spmtmod <- reactive({
  
  # inputs
  spmtdat <- spmtdat()
  
  mod <- glm(occurrbin ~ val, spmtdat, family = 'binomial')
  
  return(mod)
  
})
```

#### Observed data

```{r}
# mapview
output$spmapobs <- renderLeaflet({spmapobs()@map})
```
```{r}
leafletOutput('spmapobs', height = 700) %>% withSpinner()
```

#### Modelled response

```{r}
output$spmtplt <- renderPlot({spmtplt()}, width = 500, height = 500)
```
```{r}
column(12,
  column(width = 6, 
         plotOutput('spmtplt')
  ), 
  column(width = 6,
          HTML('<br>'), 
          # renderText({
          #   
          #   spmtmod <- spmtmod()
          #   
          #   dat <- spmtmod %>% 
          #     summary %>% 
          #     coef %>% 
          #     .[2, 4] %>% 
          #     paste('p =', .)
          #   return(dat)
          #   
          # }),
          renderUI({
            
            # input
            spmtmod <- spmtmod()
            metsel <- input$metsel
            
            req(metsel)
            
            cvars <- c(metsel, 'intercept')
            
            spmtmod %>%
              stargazer(., type = 'html', dep.var.labels = 'presence/absence', covariate.labels = c('metric', 'intercept')) %>% 
              HTML
            
          })
  )
)
```

### Baseline conditions

```{r}
column(width = 12,

    column(width = 4,

          # select species to show
          selectInput("spmapbs", "Choose species:", choices = spls)

    ),

    column(width = 4,

          # select prediction type
          selectInput("bsmettyp", 'Select prediction type:', choices = c("Temperature" = 'temp', "Flow" = 'flow', 'Synthesis' = 'syn'), selected = 'Synthesis')

    ),

    column(width = 4,
          
          # select baseline conditions
          selectInput('bstyp', 'Select baseline conditions:', choices = list(`dry (2014)` = '2014', `moderate (2010)` = '2010', `wet (1993)` = '1993'))

    )

)
```

```{r}
# probability of occurrence predictions for species and baseline condition
bsprds <- reactive({

  # input
  spmapbs <- input$spmapbs
  bsmettyp <- input$bsmettyp
  bstyp <- input$bstyp
  
  # filter baseline predictions
  out <- bsest %>% 
    filter(spp %in% spmapbs) %>% 
    filter(dts %in% bstyp) %>% 
    filter(bsmettyp %in% !!bsmettyp)
  
  return(out)

})

# map of predictions by comid
bsprdsmap <- reactive({

  # input
  bsprds <- bsprds()

  tomapbs <- rchdat %>%
    left_join(bsprds, by = 'COMID')

  mapview(tomapbs, layer.name = NULL) %>%
    .@map   %>% 
    clearMarkers() %>%
    clearShapes() %>%
    clearControls() %>%
    addPolylines(data = tomapbs, opacity = 1, weight = 1, color = ~pal(prd),
      label = ~as.character(round(prd, 2))
      ) %>% 
    addLegend(data = tomapbs, "topright", pal = pal, values = ~prd,
              title = "Pr. occurence", opacity = 1
    )

})
```

```{r}
output$bsprdsmap <- renderLeaflet({bsprdsmap()})
```
```{r}
leafletOutput('bsprdsmap', height = 700) %>% withSpinner()
```

### Future scenarios

```{r}
column(width = 12,

       column(width = 3, 
              
              # select species to show
              selectInput("spmap", "Choose species:", choices = spls)
                
        ), 
       
       column(width = 3,
              
              # select metric type
              selectInput("clmmod", "Select climate model", choices = list('CanESM2' = 'CanESM2', 'CCSM4' = 'CCSM4', 'MIROC5' = 'MIROC5'))
       
        ),
       
       column(width = 3, 
              
              # select model year  
              selectInput("futyr", 'Select future year:', choices = c("2040" = '2040', "2100" = '2100'))
              
        ),
       
       column(width = 3, 
              
              # select prediction type year  
              selectInput("futmettyp", 'Select prediction type:', choices = c("Temperature" = 'temp', "Flow" = 'flow', 'Synthesis' = 'syn'), selected = 'syn')
              
        )
       
      
)
```

```{r}
# future predictions for selection
futprds <- reactive({
  
  # input
  spmap <- input$spmap
  clmmod <- input$clmmod
  futyr <- input$futyr
  futmettyp <- input$futmettyp

  # filter predictions by selection
  out <- futest %>% 
    filter(spp %in% spmap) %>% 
    filter(mds %in% clmmod) %>% 
    filter(futyr %in% futyr) %>% 
    filter(mettyp %in% futmettyp)
  
  return(out)
  
})


# map of predictions by comid 
futprdsmap <- reactive({
  
  # input
  futprds <- futprds()

  tomap <- allrchdat %>% 
    inner_join(futprds, by = 'COMID')

  mapview(tomap, layer.name = NULL) %>% 
    .@map %>% 
    clearMarkers() %>%
    clearShapes() %>%
    clearControls() %>%
    addPolylines(data = tomap, opacity = 1, weight = 1, color = ~pal(prd),
      label = ~as.character(round(prd, 2))
      ) %>%
    addLegend(data = tomap, "topright", pal = pal, values = ~prd,
              title = "Pr. occurence", opacity = 1
    )

})
```

```{r}
output$futprdsmap <- renderLeaflet({futprdsmap()})
```
```{r}
leafletOutput('futprdsmap', height = 700) %>% withSpinner()
```